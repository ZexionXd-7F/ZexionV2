# node-webpmux

A mostly-complete pure Javascript re-implementation of webpmux.<br />
Can load "simple" lossy/lossless images as well as animations.

### Install
```npm install node-webpmux```

### Basic usage
```javascript
const WebP = require('node-webpmux');
let img = new WebP.Image();
// Load an animation
await img.load('img.webp');
// Extract the (unprocessed) fourth frame
await img.demux('.', { frame: 3 });
// Replace the fourth frame with a new image from disk
await img.replaceFrame(3, 'different.webp'); // This preserves the existing frame settings
// Alternatively you can do
//   let frame = Image.generateFrame({ path: 'different.webp' });
//   img.frames[3] = frame;
// Which will completely replace the frame
// Save a new copy
await img.save({ path: 'newimg.webp' });
// Or alternatively, img.save() to save over the existing one
```
### Exports
`TYPE_LOSSY`<br />
`TYPE_LOSSLESS`<br />
`TYPE_EXTENDED`<br />
Constants for what type of image is loaded.

`encodeResults`: enum of values that set[Image/Frame]Data returns.

`Image`: The main class.

### Class definition:

#### Class properties

##### `.width` (read-only)
The width of the loaded image.

##### `.height` (read-only)
The height of the loaded image.

##### `.type` (read-only)
The type of image from the TYPE_* constants table.

##### `.hasAnim` (read-only)
A boolean flag for easily checking if the image is an animation.

##### `.hasAlpha` (read-only)
A boolean flag for easily checking if the image has transparency in any way.

##### `.frames` (read-only)
Returns the array of frames, if any, or undefined.<br />
Note that while the frames themselves are read/write, you shouldn't modify them.

##### `.frameCount` (read-only)
The number of frames in the image's animation, or 0 if it's not an animation.

##### `.anim` (read-only)
Direct access to the raw animation data (see below in the _Layout for internal Image data_ section).

##### `.iccp` (read/write)
A Buffer containing the raw ICCP data stored in the image, or undefined if there isn't any.

##### `.exif` (read/write)
A Buffer containing the raw EXIF data stored in the image, or undefined if there isn't any.

##### `.xmp` (read/write)
A Buffer containing the raw XMP data stored in the image, or undefined if there isn't any.

#### Image member functions

##### `async .initLib()`
Calls Image.initLib(). This member function is no longer particularly useful and is kept for convenience.

##### `async .load(source)`
If `source` is a string, it tries to load that as a path to a WebP image.<br />
If `source` is a buffer, it tries to load the contents of the buffer as a WebP image.

##### `.convertToAnim()`
Sets the image up for being an animation.

##### `async .demux({ path = undefined, buffers = false, frame = -1, prefix = '#FNAME#', start = 0, end = 0 })`
Dump the individual, unprocessed WebP frames to a directory.
* `path`: The directory to dump the frames to, if desired.
* `buffers`: Return the frames as an array of Buffers instead of dumping to a path.
* `prefix`: What to prefix the frame names with. Default is the file name of the original image (without .webp).
    Format is \<prefix\>_\<frame number\>.webp.
* `frame`: What frame to dump. Defaults to -1, which has it dump all available frames. Overrides `start`/`end`.
* `start`: The first frame to dump. Defaults to the first frame.
* `end`: The last frame to dump. Defaults to the last frame.

##### `async .replaceFrame(frame, source)`
Replaces a frame in the animation with another image from `source`. All other frame settings are preserved.
* `frame`: Which frame to replace. Frame indexes are 0-based.
* `source`: If this is a string, the frame is loaded from disk. If this is a Buffer, the frame is loaded from there.

##### `async .save(path = this.path, options)`
Save the image to `path`. Options are described below in the _Options for saving_ section.<br />
If `path` is `null`, this will save the image to a Buffer and return it.

##### `async .getImageData()`
Get the raw RGBA pixel data for the image.<br />
Returns a Buffer in the format `[ r, g, b, a, r, g, b, a, ... ]`. Values are range 0 - 255.<br />
Use this for non-animations.<br />
On error, this returns a Buffer full of 0s.

##### `async .setImageData(buf, { width = 0, height = 0, preset = 0, quality = 75, exact = false, lossless = 0, method = 4, advanced = undefined })`
Encode `buf` as a new WebP using the provided settings and replace the image pixel data with it.<br />
This preserves EXIF/ICCP/XMP if present.<br />
Use this for non-animations.<br />
Options:
* `width`/`height`<br />
    If either are > 0, override the existing width and/or height with this value.<br />
    Use this if the pixel data in `buf` has different dimensions than the original image.
* `preset`: What image preset to use, if any.<br />
    Range is 0 - 5<br />
    Default is 0 (DEFAULT).<br />
    An enum of constants can be found under WebP.presets
* `quality`: What quality to set.<br />
    Range is 0 - 100.<br />
    Default is 75.
* `exact`: Preserve data in transparent pixels.<br />
    Defaults to `false`, which means transparent pixels may be modified to help with compression.
